<div class="story-viewer-container" [class.fullscreen]="isFullscreen">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-overlay">
    <div class="loading-content">
      <i class="pi pi-spin pi-spinner"></i>
      <p>Loading story...</p>
    </div>
  </div>

  <!-- Story Content -->
  <div *ngIf="!isLoading && story" class="story-content" 
       (touchstart)="onTouchStart($event)" 
       (touchmove)="onTouchMove($event)" 
       (touchend)="onTouchEnd($event)">
    
    <!-- Progress Bars (Instagram Style) -->
    <div class="story-progress-bars">
      <div class="progress-bar-segment" *ngFor="let s of allStories; let i = index">
        <div class="progress-fill" 
             [class.active]="i === currentStoryIndex"
             [class.completed]="i < currentStoryIndex"
             [style.width.%]="getProgressWidth(i)">
        </div>
      </div>
    </div>

    <!-- Top Header (User Info & Close) -->
    <div class="story-header">
      <div class="user-section" (click)="onClose()">
        <div class="user-avatar" 
             [style.background-image]="story.userAvatar ? 'url(' + story.userAvatar + ')' : 'none'">
          <span *ngIf="!story.userAvatar">{{ story.userName?.charAt(0)?.toUpperCase() }}</span>
        </div>
        <div class="user-info">
          <span class="user-name">{{ story.userName }}</span>
          <span class="story-time">{{ formatDate(story.createdAt) }}</span>
        </div>
      </div>
      
      <button pButton 
        type="button"
        icon="pi pi-times" 
        class="p-button-rounded p-button-text close-button"
        (click)="onClose()">
      </button>
    </div>
    
    <!-- Video Player (Full Screen) -->
    <div class="video-container">
      <video #videoPlayer
        [src]="videoBlobUrl"
        (timeupdate)="onVideoTimeUpdate()"
        (ended)="onVideoEnded()"
        (error)="onVideoError($event)"
        (loadeddata)="onVideoLoaded()"
        class="video-player"
        preload="metadata"
        playsinline
        [muted]="isMuted"
        loop="false">
        Your browser does not support the video tag.
      </video>

      <!-- Tap Zones for Navigation (Instagram Style) -->
      <div class="tap-zone tap-zone-left" (click)="previousStory()"></div>
      <div class="tap-zone tap-zone-right" (click)="nextStory()"></div>
      
      <!-- Pause Overlay -->
      <div class="pause-overlay" *ngIf="!isPlaying && !isLoading">
        <i class="pi pi-play"></i>
      </div>
    </div>

    <!-- Bottom Actions (Instagram Style) -->
    <div class="story-bottom">
      <!-- Caption & Tags -->
      <div class="story-caption" *ngIf="story.caption">
        <p>{{ story.caption }}</p>
      </div>

      <!-- Action Buttons -->
      <div class="story-actions">
        <!-- Left Side: Comment Input -->
        <div class="comment-input-section" (click)="toggleComments()">
          <input type="text" 
                 placeholder="Send message..." 
                 class="comment-input"
                 readonly>
        </div>

        <!-- Right Side: Actions -->
        <div class="action-buttons">
          <button class="action-btn" (click)="onLikeStory()">
            <i [class]="isLiked ? 'pi pi-heart-fill liked' : 'pi pi-heart'"></i>
            <span>{{ story.likes | number }}</span>
          </button>
          
          <button class="action-btn" (click)="toggleComments()">
            <i class="pi pi-comments"></i>
            <span>{{ story.comments | number }}</span>
          </button>
          
          <button class="action-btn" (click)="toggleMute()">
            <i [class]="isMuted ? 'pi pi-volume-off' : 'pi pi-volume-up'"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Comments Panel (Bottom Sheet Style) -->
    <div class="comments-panel" [class.show]="showComments" (click)="$event.stopPropagation()">
      <div class="comments-handle" (click)="toggleComments()">
        <div class="handle-bar"></div>
      </div>

      <div class="comments-header">
        <h3>Comments ({{ story.comments }})</h3>
        <button class="close-comments" (click)="toggleComments()">
          <i class="pi pi-times"></i>
        </button>
      </div>

      <div class="comments-list">
        <div *ngIf="comments.length === 0" class="no-comments">
          <i class="pi pi-comments"></i>
          <p>No comments yet</p>
        </div>
        
        <div class="comment-item" *ngFor="let comment of comments">
          <div class="comment-avatar" 
               [style.background-image]="comment.userAvatar ? 'url(' + comment.userAvatar + ')' : 'none'">
            <span *ngIf="!comment.userAvatar">{{ comment.userName?.charAt(0)?.toUpperCase() }}</span>
          </div>
          <div class="comment-content">
            <div class="comment-header">
              <span class="comment-author">{{ comment.userName }}</span>
              <span class="comment-time">{{ formatDate(comment.createdAt) }}</span>
            </div>
            <p class="comment-text">{{ comment.content }}</p>
          </div>
        </div>
      </div>

      <div class="comment-input-box">
        <input type="text" 
          placeholder="Add a comment..."
          [(ngModel)]="newComment"
          (keyup.enter)="onAddComment()"
          class="comment-field">
        <button class="send-btn" 
                (click)="onAddComment()"
                [disabled]="!newComment.trim()">
          <i class="pi pi-send"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="!isLoading && !story" class="error-state">
    <i class="pi pi-exclamation-triangle"></i>
    <h3>Story Not Found</h3>
    <p>The story you're looking for doesn't exist or has been removed.</p>
    <button pButton 
      label="Go Back" 
      icon="pi pi-arrow-left"
      class="p-button-primary"
      (click)="onGoBack()">
    </button>
  </div>
</div>

<p-toast></p-toast> 