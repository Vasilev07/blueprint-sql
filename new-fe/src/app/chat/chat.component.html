<div class="chat-container">
  <!-- Sidebar removed -->
  <!-- Header -->
  <div class="chat-header">
    <button pButton
            type="button"
            icon="pi pi-arrow-left"
            class="p-button-text p-button-rounded back-btn"
            pTooltip="Back"
            (click)="goBack()"></button>

    <div class="chat-user-info" (click)="openUserProfile()">
      <img [src]="headerProfilePictureUrl()"
           [alt]="otherUserName()"
           (error)="onImageError($event)"
           class="chat-header-avatar">
      <div class="user-details">
        <h3>{{ otherUserName() }}</h3>
        <div class="user-status" [ngClass]="{ 'online': isOtherUserOnline(), 'offline': !isOtherUserOnline() }">
          {{ otherUserStatus() }}
        </div>
      </div>
    </div>

    <div class="chat-actions">
      <button pButton
        type="button"
        icon="pi pi-phone"
        class="p-button-text video-call-btn"
        pTooltip="Video Call"
        (click)="startVideoCall()">
      </button>
      <button pButton
        type="button"
        icon="pi pi-gift"
        class="gift-btn"
        pTooltip="Send Gift"
        (click)="openSendGiftDialog()">
      </button>
      <button pButton type="button" icon="pi pi-search" class="p-button-text" pTooltip="Search"></button>
      <button pButton type="button" icon="pi pi-ellipsis-v" class="p-button-text" pTooltip="More"></button>
    </div>
  </div>

  <!-- Chat Messages -->
  <div class="chat-messages" [class.loading]="isLoading()">
    @if (isLoading()) {
      <div class="loading-messages">
        <i class="pi pi-spin pi-spinner"></i>
        <p>Loading messages...</p>
      </div>
    }

    @if (!isLoading() && messages().length === 0) {
      <div class="empty-messages">
        <i class="pi pi-comments"></i>
        <h3>No messages yet</h3>
        <p>Start the conversation by sending a message!</p>
      </div>
    }

    @for (message of messages(); track trackByMessageId($index, message)) {
      <div class="message-wrapper"
           [class.own-message]="isOwnMessage(message)"
           [class.gift-message]="isGiftMessage(message)">

        <!-- Gift Message Display -->
        @if (isGiftMessage(message)) {
          <div class="gift-message-bubble" [ngClass]="{'own-gift': isOwnMessage(message)}">
            <!-- Show sender avatar for gift messages from others -->
            @if (!isOwnMessage(message)) {
              <div class="gift-message-avatar">
                <img
                  [src]="getSenderProfilePicture(message.senderId)"
                  [alt]="getSenderInitials(message.senderId)"
                  (error)="onImageError($event)"
                  class="avatar-image">
              </div>
            }

            @if (message | parseGiftMessage; as parsedGift) {
              <div class="gift-message-container">
                <div class="gift-sparkles">
                  <span class="sparkle sparkle-1">âœ¨</span>
                  <span class="sparkle sparkle-2">âœ¨</span>
                  <span class="sparkle sparkle-3">âœ¨</span>
                  <span class="sparkle sparkle-4">âœ¨</span>
                </div>

                <div class="gift-message-header">
                  <div class="gift-emoji-large">{{ parsedGift?.emoji || 'ğŸ' }}</div>
                  <div class="gift-info">
                    <div class="gift-label">
                      <i class="pi pi-gift"></i>
                      <span>{{ isOwnMessage(message) ? 'You sent a gift' : 'Gift Sent' }}</span>
                    </div>
                    @if (!isOwnMessage(message)) {
                      <div class="gift-sender-name">
                        <i class="pi pi-user"></i>
                        <span>{{ getSenderName(message.senderId) }}</span>
                      </div>
                    }
                    <div class="gift-amount">
                      <i class="pi pi-wallet"></i>
                      <span>{{ parsedGift?.amount || '0' }} tokens</span>
                    </div>
                  </div>
                </div>

                @if (parsedGift?.giftMessage) {
                  <div class="gift-message-text">
                    <i class="pi pi-quote-left"></i>
                    <span>{{ parsedGift.giftMessage }}</span>
                    <i class="pi pi-quote-right"></i>
                  </div>
                }

                <div class="gift-message-footer">
                  <span class="message-time">{{ formatTime(message.timestamp) }}</span>
                  @if (isOwnMessage(message)) {
                    <div class="message-status">
                      <i class="pi pi-check-double read"></i>
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        }

        <!-- Regular Message Display -->
        @if (!isGiftMessage(message)) {
          <div>
            @if (!isOwnMessage(message)) {
              <div class="message-avatar">
                <img
                  [src]="getSenderProfilePicture(message.senderId)"
                  [alt]="getSenderInitials(message.senderId)"
                  (error)="onImageError($event)"
                  class="avatar-image">
              </div>
            }
            <div class="message-bubble">
              <div class="message-content">{{ message.content }}</div>
              <div class="message-footer">
                <span class="message-time">{{ formatTime(message.timestamp) }}</span>
                @if (isOwnMessage(message)) {
                  <div class="message-status">
                    @if (message.isRead) {
                      <i class="pi pi-check-double read"></i>
                    } @else {
                      <i class="pi pi-check"></i>
                    }
                  </div>
                }
              </div>
            </div>
          </div>
        }
      </div>
    }
  </div>

  <!-- Chat Input -->
  <div class="chat-input">
    <form [formGroup]="messageForm" (ngSubmit)="sendMessage()" class="message-form">
      <div class="input-container">
        <button pButton
          type="button"
          icon="pi pi-paperclip"
          class="p-button-text p-button-rounded attachment-btn"
          pTooltip="Attach File"
          tooltipPosition="top">
        </button>

        <input pInputText
          formControlName="content"
          placeholder="Type your message..."
          class="message-input"
          autocomplete="off"
          autocorrect="on"
          autocapitalize="sentences"
          spellcheck="true"
          [class.ng-invalid]="messageForm.get('content')?.invalid && messageForm.get('content')?.touched">

        <button pButton
          type="submit"
          icon="pi pi-send"
          class="p-button-rounded send-btn"
          [disabled]="messageForm.invalid"
          pTooltip="Send Message"
          tooltipPosition="top">
        </button>
      </div>

      @if (messageForm.get('content')?.invalid && messageForm.get('content')?.touched) {
        <div class="validation-error">
          @if (messageForm.get('content')?.errors?.['required']) {
            <small>Message is required</small>
          }
          @if (messageForm.get('content')?.errors?.['maxlength']) {
            <small>Message too long (max 1000 chars)</small>
          }
        </div>
      }
    </form>
  </div>
</div>

<!-- Send Gift Dialog -->
<app-send-gift-dialog
  [visible]="showSendGiftDialog()"
  (visibleChange)="showSendGiftDialog.set($event)"
  [recipientUser]="recipientUserForGift()"
  (giftSent)="onGiftSent($event)">
</app-send-gift-dialog>

<!-- Toast Messages -->
<p-toast></p-toast>
