<div class="profile-container">
  <!-- Profile Header -->
  <div class="profile-header">
    <div class="user-info">
      <h1 class="user-name">{{ currentUser?.fullName || 'User' }}</h1>
      <div class="user-details">
        <div class="user-location">
          <i class="pi pi-map-marker"></i>
          <span>{{ currentUser?.city || 'City not set' }}</span>
        </div>
        <div class="user-gender" *ngIf="currentUser?.gender">
          <i class="pi pi-user"></i>
          <span>{{ currentUser?.gender | titlecase }}</span>
        </div>
      </div>
      <p-button
        *ngIf="isOwnProfile"
        icon="pi pi-pencil"
        label="Edit Profile"
        styleClass="p-button-sm p-button-outlined"
        (onClick)="openEditDialog()">
      </p-button>
    </div>
    <div class="user-avatar">
      <p-avatar
        *ngIf="!hasProfilePicture()"
        [label]="getUserInitials()"
        size="xlarge"
        styleClass="profile-avatar">
      </p-avatar>
      <p-avatar
        *ngIf="hasProfilePicture()"
        [image]="getProfilePictureUrl()"
        size="xlarge"
        styleClass="profile-avatar">
      </p-avatar>
      <div class="avatar-upload" *ngIf="isOwnProfile">
        <p-fileUpload
          mode="basic"
          name="photo"
          accept="image/*"
          maxFileSize="10000000"
          (onUpload)="onProfilePictureUpload($event)"
          (onSelect)="onProfilePictureUpload($event)"
          chooseIcon="pi pi-camera"
          [chooseLabel]="hasProfilePicture() ? 'Change' : 'Upload'"
          styleClass="p-button-sm p-button-rounded">
        </p-fileUpload>
      </div>
    </div>
  </div>

  <!-- Main Content with Tabs -->
  <div class="main-content">
    <div class="content-area">
      <p-tabView>
        <!-- Photos Tab -->
        <p-tabPanel header="Photos">
          <div class="photos-content">
            <!-- Profile Images Section -->
            <div class="profile-images-section">
              <h3 class="section-title">PROFILE IMAGES</h3>
              <div class="visibility-info">
                <span class="visibility-label">Public</span>
              </div>

              <div class="profile-images-gallery">
                <div *ngIf="userPhotos.length === 0" class="empty-gallery">
                  <div class="empty-gallery-content">
                    <i class="pi pi-camera empty-icon"></i>
                    <p class="empty-text">
                      This gallery is still empty. This gallery is only visible to you since it is empty.
                    </p>
                    <p-fileUpload
                      *ngIf="isOwnProfile"
                      mode="basic"
                      name="photo"
                      accept="image/*"
                      maxFileSize="10000000"
                      (onUpload)="onPhotoUpload($event)"
                      (onSelect)="onPhotoUpload($event)"
                      chooseLabel="Choose Photo"
                      styleClass="upload-button">
                    </p-fileUpload>
                    <p *ngIf="!isOwnProfile" class="viewing-message">
                      You are viewing {{ currentUser?.fullName }}'s profile
                    </p>
                  </div>
                </div>

                <div *ngIf="userPhotos.length > 0" class="photos-grid">
                  <div *ngFor="let photo of userPhotos" class="photo-item" (click)="openPhotoDialog(photo)">
                    <img
                      [src]="getPhotoUrl(photo.id!)"
                      [alt]="photo.name"
                      class="photo-image">
                    <div class="photo-overlay">
                      <!-- Instagram-like stats overlay -->
                      <div class="photo-stats">
                        <div class="stat-item">
                          <i [class]="photo.isLikedByCurrentUser ? 'pi pi-heart-fill' : 'pi pi-heart'"></i>
                          <span>{{ photo.likesCount || 0 }}</span>
                        </div>
                      </div>
                      
                      <!-- Profile picture badge -->
                      <div *ngIf="currentUser?.profilePictureId === photo.id" class="profile-pic-badge">
                        <i class="pi pi-check-circle"></i>
                        <span>Profile Picture</span>
                      </div>
                      
                      <!-- Action buttons (only visible on own profile) -->
                      <div *ngIf="isOwnProfile" class="photo-actions" (click)="$event.stopPropagation()">
                        <p-button
                          *ngIf="currentUser?.profilePictureId !== photo.id"
                          label="Set as Profile"
                          icon="pi pi-check-circle"
                          styleClass="p-button-sm p-button-outlined"
                          (onClick)="setPhotoAsProfilePicture(photo.id!); $event.stopPropagation()">
                        </p-button>
                        <p-button
                          label="Delete"
                          icon="pi pi-trash"
                          styleClass="p-button-sm p-button-outlined p-button-danger"
                          (onClick)="deletePhoto(photo.id!); $event.stopPropagation()">
                        </p-button>
                      </div>
                    </div>
                  </div>

                  <!-- Add more photos button -->
                  <div class="add-photo-item" *ngIf="isOwnProfile">
                    <div class="add-photo-content">
                      <i class="pi pi-plus"></i>
                      <span>Add Photo</span>
                      <p-fileUpload
                        mode="basic"
                        name="photo"
                        accept="image/*"
                        maxFileSize="10000000"
                        (onUpload)="onPhotoUpload($event)"
                        (onSelect)="onPhotoUpload($event)"
                        chooseLabel="Choose File"
                        styleClass="p-button-sm">
                      </p-fileUpload>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </p-tabPanel>

        <!-- Videos Tab -->
        <p-tabPanel header="Videos">
          <div class="videos-content">
            <p>Videos content coming soon...</p>
          </div>
        </p-tabPanel>

        <!-- What's Up Tab -->
        <p-tabPanel header="What's Up">
          <div class="whats-up-content">
            <p>What's up content coming soon...</p>
          </div>
        </p-tabPanel>

        <!-- Friends Tab -->
        <p-tabPanel header="Friends">
          <div class="friends-content">
            <p>Friends content coming soon...</p>
          </div>
        </p-tabPanel>

        <!-- Groups Tab -->
        <p-tabPanel header="Groups">
          <div class="groups-content">
            <p>Groups content coming soon...</p>
          </div>
        </p-tabPanel>

        <!-- Validations Tab -->
        <p-tabPanel header="Validations">
          <div class="validations-content">
            <p>Validations content coming soon...</p>
          </div>
        </p-tabPanel>
      </p-tabView>
    </div>

    <!-- Right Sidebar -->
    <div class="right-sidebar">
      <div class="sidebar-content">
        <!-- Trial Membership -->
        <div class="sidebar-section">
          <div class="section-header">
            <i class="pi pi-star"></i>
            <span>Trial membership</span>
          </div>
        </div>

        <!-- Friends Section -->
        <div class="sidebar-section" *ngIf="isOwnProfile">
          <div class="section-header">
            <h4>FRIENDS {{ friends.length }}</h4>
            <p-button
              icon="pi pi-plus"
              styleClass="p-button-text p-button-sm add-friend-btn">
            </p-button>
          </div>
          <div class="friends-list">
            <div *ngFor="let friend of friends" class="friend-item">
              <div class="friend-avatar-container">
                <p-avatar
                  [label]="friend.user?.firstname?.charAt(0) || 'F'"
                  styleClass="friend-avatar">
                </p-avatar>
                <span class="online-status" [class.online]="isOnline(friend.friendId)"></span>
              </div>
              <div class="friend-info">
                <span class="friend-name">{{ friend.user?.firstname }}</span>
                <span class="friend-status" *ngIf="isOnline(friend.friendId)">Online</span>
              </div>
              <p-button
                icon="pi pi-comment"
                (onClick)="startChat(friend)"
                [rounded]="true"
                [text]="true"
                styleClass="chat-button"
                pTooltip="Chat"
                tooltipPosition="left">
              </p-button>
            </div>
            <div *ngIf="friends.length === 0" class="no-friends">
              <p>No friends yet</p>
            </div>
          </div>
        </div>

        <!-- Bio Section -->
        <div class="sidebar-section" *ngIf="userProfile?.bio || isOwnProfile">
          <div class="section-header">
            <h4>BIO</h4>
            <p-button
              *ngIf="isOwnProfile"
              label="Edit"
              icon="pi pi-pencil"
              (onClick)="openEditDialog()"
              styleClass="p-button-text p-button-sm">
            </p-button>
          </div>
          <div class="info-content">
            <i class="pi pi-comment"></i>
            <span>{{ userProfile?.bio || 'Not specified' }}</span>
          </div>
        </div>

        <!-- Location Section -->
        <div class="sidebar-section" *ngIf="userProfile?.location || isOwnProfile">
          <div class="section-header">
            <h4>LOCATION</h4>
            <p-button
              *ngIf="isOwnProfile"
              label="Edit"
              icon="pi pi-pencil"
              (onClick)="openEditDialog()"
              styleClass="p-button-text p-button-sm">
            </p-button>
          </div>
          <div class="info-content">
            <i class="pi pi-map-marker"></i>
            <span>{{ userProfile?.location || 'Not specified' }}</span>
          </div>
        </div>

        <!-- Interests Section -->
        <div class="sidebar-section" *ngIf="(userProfile && userProfile.interests && userProfile.interests.length > 0) || isOwnProfile">
          <div class="section-header">
            <h4>INTERESTS</h4>
            <p-button
              *ngIf="isOwnProfile"
              label="Edit"
              icon="pi pi-pencil"
              (onClick)="openEditDialog()"
              styleClass="p-button-text p-button-sm">
            </p-button>
          </div>
          <div class="info-content interests-list">
            <div *ngIf="userProfile && userProfile.interests && userProfile.interests.length > 0" class="interest-chips">
              <p-chip
                *ngFor="let interest of userProfile.interests"
                [label]="interest"
                styleClass="interest-chip">
              </p-chip>
            </div>
            <span *ngIf="!userProfile || !userProfile.interests || userProfile.interests.length === 0">Not specified</span>
          </div>
        </div>

        <!-- Gender Section -->
        <div class="sidebar-section">
          <div class="section-header">
            <h4>GENDER</h4>
            <p-button
              *ngIf="isOwnProfile"
              label="Edit"
              icon="pi pi-pencil"
              (onClick)="openEditDialog()"
              styleClass="p-button-text p-button-sm">
            </p-button>
          </div>
          <div class="info-content">
            <i class="pi pi-user"></i>
            <span>{{ currentUser?.gender ? (currentUser?.gender | titlecase) : 'Not specified' }}</span>
          </div>
        </div>

        <!-- City Section -->
        <div class="sidebar-section">
          <div class="section-header">
            <h4>CITY</h4>
            <p-button
              *ngIf="isOwnProfile"
              label="Edit"
              icon="pi pi-pencil"
              (onClick)="openEditDialog()"
              styleClass="p-button-text p-button-sm">
            </p-button>
          </div>
          <div class="info-content">
            <i class="pi pi-map-marker"></i>
            <span>{{ currentUser?.city || 'Not specified' }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Profile Dialog -->
<p-dialog
  [(visible)]="showEditDialog"
  header="Edit Profile"
  [modal]="true"
  [style]="{ width: '650px', maxWidth: '90vw' }"
  [draggable]="false"
  [resizable]="false">
  
  <div class="edit-form">
    <div class="field">
      <label for="bio">Bio</label>
      <textarea
        id="bio"
        rows="3"
        pInputTextarea
        [(ngModel)]="editForm.bio"
        placeholder="Looking for fun connections ðŸ’•"
        [style]="{ width: '100%' }">
      </textarea>
    </div>

    <div class="field">
      <label for="location">Location</label>
      <div class="p-inputgroup">
        <span class="p-inputgroup-addon"><i class="pi pi-map-marker"></i></span>
        <input
          id="location"
          type="text"
          pInputText
          [(ngModel)]="editForm.location"
          placeholder="Los Angeles, CA"
          [style]="{ width: '100%' }" />
      </div>
    </div>

    <div class="field">
      <label for="interests">Interests</label>
      <div class="interests-input">
        <div class="interests-chips" *ngIf="editForm.interests && editForm.interests.length > 0">
          <p-chip
            *ngFor="let interest of editForm.interests"
            [label]="interest"
            [removable]="true"
            (onRemove)="removeInterest(interest)"
            styleClass="custom-chip">
          </p-chip>
        </div>
        <div class="p-inputgroup">
          <input
            type="text"
            pInputText
            [(ngModel)]="newInterest"
            (keyup.enter)="addInterest()"
            placeholder="Add interest"
            [style]="{ width: '100%' }" />
          <button
            pButton
            type="button"
            icon="pi pi-plus"
            label="Add Interest"
            (click)="addInterest()"
            styleClass="p-button-outlined">
          </button>
        </div>
      </div>
    </div>

    <div class="field">
      <label>Privacy</label>
      <div class="privacy-setting">
        <div class="privacy-item">
          <div>
            <strong>Show in Search</strong>
            <p class="privacy-description">Appear in browse results</p>
          </div>
          <p-inputSwitch [(ngModel)]="editForm.appearsInSearches"></p-inputSwitch>
        </div>
      </div>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <p-button
      label="Cancel"
      icon="pi pi-times"
      (onClick)="showEditDialog = false"
      styleClass="p-button-text">
    </p-button>
    <p-button
      label="Save"
      icon="pi pi-check"
      (onClick)="saveProfile()">
    </p-button>
  </ng-template>
</p-dialog>

<!-- Photo Detail Dialog -->
<p-dialog
  [(visible)]="showPhotoDialog"
  [modal]="true"
  [style]="{ width: '90vw', maxWidth: '900px' }"
  [dismissableMask]="true"
  styleClass="photo-dialog">
  
  <ng-template pTemplate="header">
    <div class="dialog-header">
      <span>Photo Details</span>
    </div>
  </ng-template>

  <div class="photo-dialog-content" *ngIf="selectedPhoto">
    <div class="photo-display">
      <img [src]="getPhotoUrl(selectedPhoto.id!)" [alt]="selectedPhoto.name">
    </div>
    
    <div class="photo-info">
      <div class="photo-actions-bar">
        <p-button
          [icon]="selectedPhoto.isLikedByCurrentUser ? 'pi pi-heart-fill' : 'pi pi-heart'"
          [label]="(selectedPhoto.likesCount || 0).toString()"
          styleClass="p-button-text p-button-lg like-button"
          [class.liked]="selectedPhoto.isLikedByCurrentUser"
          (onClick)="togglePhotoLike(selectedPhoto)">
        </p-button>
      </div>
      
      <p-divider></p-divider>
      
      <div class="photo-metadata">
        <p><strong>Uploaded:</strong> {{ selectedPhoto.uploadedAt | date: 'medium' }}</p>
        <p><strong>Likes:</strong> {{ selectedPhoto.likesCount || 0 }}</p>
      </div>
    </div>
  </div>
</p-dialog>

<!-- Loading Spinner -->
<p-progressSpinner
  *ngIf="isLoading || isUploading"
  styleClass="loading-spinner">
</p-progressSpinner>

<!-- Toast Messages -->
<p-toast></p-toast>

<!-- Confirmation Dialog -->
<p-confirmDialog></p-confirmDialog>

